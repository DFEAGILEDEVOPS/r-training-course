# Maps

Maps in R are best plotted using <span class="code">ggplot</span> - which is good, because we already know how to use that! However, the new thing about maps is the sort of data we'll be using - as well as having data about certain variables, this data has a location attached to it too.

First, we need to load in the packages we need. We'll need the following packages:

* <span class="code">tidyverse</span>, as this contains <span class="code">ggplot</span> for plotting and <span class="code">dplyr</span> for data manipulation
* <span class="code">rgdal</span>, a package for loading in spatial data

<div class="activity"><b>Activity A10.1:</b>

1. Install <span class="code">rgdal</span>
2. Use <span class="code">library()</span> to load <span class="code">tidyverse</span> and <span class="code">rgdal</span>
</div>

## Loading in geospatial data

Geospatial data comes in three forms:

* Polygons (shapes) 
* Lines
* Points

Polygons and points are the most common (geospatial line data only really features when relating to travel infrastructure or people movements), so we'll focus on these two.

Point, polygon, and line data can come in a number of different data formats, but the msot common is a 'shapefile' with a <span class="code">.shp</span> suffix. We can use the <span class="code">rgdal</span> library to load in shapefiles. Firstly, we're going to load the names of location of major UK cities using the <span class="code">readOGR</span> function.

```{r sec10_1}
cities <- "data/SHPs/england_cities.shp" %>% 
  readOGR()
```

Plotted, the cities look like this:

```{r sec10_1,echo=FALSE}
plot(cities,col="red")
```

...which looks vaguely like the UK!

You'll see <span class="code">cities</span> is a <span class="code">SpatialPointsDataFrame</span> class object. The essentially means it's a dataframe with spatial data attached.

<div class="activity"><b>Activity A10.1:</b> Click the blue circle to the left of <span class="code">cities</span> to open up the object. You'll see there's an attribute within <span class="code">cities</span> called <span class="code">data</span>, and another attribute called <span class="code">coords</span>.

Access these by typing <span class="code">cities@</span> and then whichever of the attributes you want to view.
</div>

We can also use <span class="code">readOGR</span> to load in polygon data. The file we're going to use is one containing the boundaries of Local Authorities (LAs) in England, called <span class="code">England_LA_2016.shp</span>.

```{r sec10_3,eval=FALSE}
england <- "data/SHPs/England_LA_2016.shp" %>% 
  readOGR()
```

This is a <span class="code">SpatialPolygonsDataFrame</span>, which makes sense!

However, if we plot the LAs alongside the cities, the don't match up.

```{r sec10_4,echo=FALSE}
plot(england) +
  plot(cities,add=T,col="red")
```

What we have here is all of the city points plotted down in the bottom lefthand corner (although you can only see one) over the LA map. This is because the cities data and the LA data use different 'coordinate systems'.

## Coordinate systems



## Transforming data

## Point maps

## Polygon maps

```{r}
cities <- spTransform(cities, CRS("+init=epsg:27700"))

england <- "data/SHPs/England_LA_2016.shp" %>% 
  readOGR() %>% 
  fortify(region="LA15NM") %>% 
  as.tbl() %>% 
  dplyr::select(Easting = long,
                Northing = lat,
                LAD16NM = id,
                group)

cities <- "data/SHPs/england_cities.shp" %>% 
  readOGR() %>%
  spTransform(CRS("+init=epsg:27700")) %>% 
  data.frame() %>% 
  select(City,
         Easting = coords.x1,
         Northing = coords.x2)

ggplot()+
  geom_polygon(data=england,
               aes(Easting,Northing,group=group),
               col="grey",
               fill=NA) +
  geom_point(data=cities,
             aes(Easting,Northing),
             col="red") +
  coord_equal() +
  theme_minimal() +
  geom_text(data=cities,
            aes(Easting,Northing,label=cities$City),
            check_overlap = TRUE,
            col="blue",
            hjust = 1.1,
            vjust=0.3)
```

## Point maps
```{r,eval=FALSE}
Wiltshire <- "data/SHPs/England_LA_2016.shp" %>% 
  readOGR() %>% 
  subset(LA15NM == "Wiltshire") %>% 
  fortify(region="LA15NM") %>% 
  as.tbl() %>% 
  dplyr::select(Easting = long,
                Northing = lat,
                LA15NM = id,
                group)
  
ggplot() +
  geom_polygon(data=Wiltshire,aes(Easting,Northing),col="grey",fill=NA) +
  coord_equal() +
  theme_minimal() +
  theme(axis.line=element_blank(),
        axis.text.x=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks=element_blank(),
        axis.title.x=element_blank(),
        axis.title.y=element_blank(),
        panel.background=element_blank(),
        panel.border=element_blank(),
        panel.grid.major=element_blank(),
        panel.grid.minor=element_blank(),
        plot.background=element_blank(),
        legend.title=element_blank())

wiltshire_schools <- "data/wiltshire_schools.csv" %>% read_csv()

wiltshire_schools %>% write_csv("wiltshire_schools.csv")

ggplot() +
  geom_point(data=wiltshire_schools,aes(Easting,Northing,size=Tot_Workforce_HC,
                                        col=School_Phase)) +
  geom_polygon(data=Wiltshire,aes(Easting,Northing),col="grey",fill=NA) +
  coord_equal() +
  theme_minimal() +
  theme(axis.line=element_blank(),
        axis.text.x=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks=element_blank(),
        axis.title.x=element_blank(),
        axis.title.y=element_blank(),
        panel.background=element_blank(),
        panel.border=element_blank(),
        panel.grid.major=element_blank(),
        panel.grid.minor=element_blank(),
        plot.background=element_blank(),
        legend.title=element_blank())
```

## Chloropleth maps

```{r,eval=FALSE}
library(rgdal)

England <- readOGR("data/SHPs/England_Regions.shp")
plot(England)

region_ave_salary <- "data/region_ave_salary.csv" %>% 
  read_csv()

Reg_England_df <- England %>% 
  fortify(region="rgn16nm") %>% 
  as.tbl() %>% 
  dplyr::select(Easting = long,
                Northing = lat,
                Region = id,
                group) %>% 
  left_join(region_ave_salary,c("Region"="Government_Office_Region_Name"))

ggplot() +
  geom_polygon(data=Reg_England_df,aes(Easting,Northing,
                                       group=group,
                                       fill=ave_sal),
               col="white") +
  coord_equal() +
  theme_minimal() +
  theme(axis.line=element_blank(),
        axis.text.x=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks=element_blank(),
        axis.title.x=element_blank(),
        axis.title.y=element_blank(),
        panel.background=element_blank(),
        panel.border=element_blank(),
        panel.grid.major=element_blank(),
        panel.grid.minor=element_blank(),
        plot.background=element_blank(),
        legend.title=element_blank())
```
