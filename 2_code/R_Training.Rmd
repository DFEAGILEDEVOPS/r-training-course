<head>
<title>R Training</title>
<style> 
div.activity {
    border: 2px solid #a1a1a1;
    padding: 10px 40px; 
    background: #dddddd;
    border-radius: 25px;
    font-style: italic;

}
h3 {
    background: #4286f4;
    height: 30px;
}

h3.example{
    background: #ffffff;
    height: 23px;
}

h4 {
    background: #99bdf7;
    height: 23px;
}

h4.example{
    background: #ffffff;
    height: 23px;
}

div.tip{
    margin-left: 190px;
    border: 2px solid #000000;
    padding: 10px 20px;
    width: 500px;
}

span.code {
    font-family: "courier";
    font-style: normal
}

div.activity span.code {
    font-family: "courier";
    font-style: normal
}

</style>
</head>
```{r sec0_1,include=FALSE}
library(tidyverse)
```
<body>
<img src="../9_Misc/Training_Pics/Department_for_Education.png" width="200"></img>

<br/>

<h3><b>R Training: The new Excel, and more</b>!</h3>

This resource is an introduction to the R programming language. It can be used as standalone learning tool, or as part of training sessions.

It takes you through from the first steps of opening RStudio through using it for visualisations such as graphs and maps - basically an introduction to using R for simple but effective data management, manipulation, calculations, and visualisation.

It does however work on the assumption that [R and R Studio](https://www.rstudio.com/products/rstudio/download/) are already installed.

<h4 id="Contents"><b>Training Contents</b></h4>

1. <a href="#Getting_set_up">Getting set up</a>:
    + Opening R Studio
    + RStudio layout
    + Setting up a project
2. <a href="#The_data">The data</a>
3. <a href="#General_coding">General coding practice</a>:
    + Objects    
    + Comments
4. <a href="#Loading_Exploring_Data">Loading in and exploring data</a>:
    + Loading in data
    + Basic dataframe functions
    + Selection certain columns/removing columns
5. <a href="#Manipulating_Dataframes"> Manipulating dataframes</a>:
    + Conditional selections
    + Altering data in dataframes
    + Writing data
6. <a href="#dplyr"><span class="code">dplyr</span></a>:
    + Packages
    + The Pipe
    + Joining
    + Selecting
    + Pivoting
    + Filtering
    + Mutating
7. <a href="#Graphs">Graphs</a>:
    + <span class="code">ggplot</span>
    + Scatter plots
    + Bar charts
    + Line graphs
    + Displaying a third variable
    + Styles
8. <a href="#Stats_Ops">Statistical Operations</a>:
    + Minimum, Maximum, and Range
    + Averages
    + Correlation
    + Significance Testing
9. <a href="#Iteration">Iteration</a>:
    + <span class="code">if</span> statements
    + <span class="code">for</span> loops
    + <span class="code">while</span> loops
    + How could we use loops?
10. <a href="#Functions">Functions</a>:
    + Writing functions
    + Applying functions repetitively
11. <a href="#Maps">Maps</a>:
    + Geospatial data
    + Point maps
    + Chloropleth maps
12. <a href="#RMarkdown">R Markdown</a>:
    + Text
    + Code
    + Multiple reports

The format of the training is as follows:

* Text describing what we will be doing

* Code showing what needs typing in:
```{r sec0_2, eval=FALSE}
print("Hello world")
```

* Activities for you to do to put your learning to the test

<div class="activity"><b>Activity A0.1:</b> Write a line of code that prints the string "Hello world"</div>
<br/>

* Little tips to make writing code easier

<div class="tip"><b>Tip:</b><br/> R is better than Excel</div>

<br/>

<h4 id="the_data"><b>The data</b> (<a href="#Contents">back to contents</a>)</h4>

We're going to use the publicly available underlying data from the Department for Education's School Workforce Census, an annual census (collected every November and published in the following July) of every single teacher in England. The statistical report for 2016 can be found [here](https://www.gov.uk/government/statistics/school-workforce-in-england-november-2016) and the Excel version of the underlying data [here](https://www.gov.uk/government/uploads/system/uploads/attachment_data/file/620828/SFR25_2017_Underlying_Data.xlsx). However, in this form it is not in particularly machine-readable format (see [here](http://opendatahandbook.org/glossary/en/terms/machine-readable/) for a definition of machine readable).

So, [here](https://drive.google.com/file/d/0B5-bg4xFFu09dmsxYm8yZGVEdVE/view) is a link to a CSV (CSV stands for Comma-Seperated Value, a type of [delimited file type](https://en.wikipedia.org/wiki/Delimiter-separated_values)).

You will need to:

1. Click on the link
2. Download the data
3. Set up a folder somewhere sensible/easily accessible in your Documents folder
4. Move the file to that folder

<h4 id="Getting_set_up"><b>Getting set up</b> (<a href="#Contents">back to contents</a>)</h4>

<h5><b>Opening R Studio:</b></h5>
First thing, open up R Studio!

Either find the RStudio icon on your desktop/start menu, or search for it in the start menu search (this is assuming you are using a Windows computer):
<br/>
<img src="../9_Misc/Training_Pics/Start_Menu.png" width="300"></img>
<hr/>
<h5><b>R Studio Layout:</b></h5>
Clink on it and the R Studio interface will open, and will look like this:
<img src="../9_Misc/Training_Pics/RStudio_First_Open.png" width="1000"></img>

There are four panes in an R Studio window:

* Top left: The script - this is where you type your scripts to be saved
* Top right: The environment - this is where R Studio shows you which objects (stuff - data tables, strings, numbers, personalised functions) you have available
*Bottom left: The console - this shows you which code you have run and any outputs you might specify, and also allows you to run lines of code which you don't need to save (e.g. to remove an object)
*Bottom right: Everything else - the help function, the place to view graphs, and the place to view which files you have available
<br/>
<hr/>
<h5><b>Setting up a project:</b></h5>
Analysis in R is carried out in 'projects'. A 'project' creates an space which contains all of the inputs, code, and outputs that relate to the analysis.

<div class="activity"><b>Activity A3.1:</b> Create a new project:

1. Click on File
2. Click on New Project
3. Click on New Directory
4. Click on Empty Project
5. In 'Directory name' type R_training
6. In 'Create project as subdirectory of' select a folder that you commonly use, like Documents
7. Click 'Create project'
8. Click File
9. Click New File
10. Click R Script
</div>
<br/>
Great, we've now created a project - all pieces of analysis should start with a project.

We now need to put some stuff in it.

<div class="activity"><b>Activity A3.2:</b> Set up your folder structure:

1. Open up your file explorer and navigate to the directory (folder) you just created in R Studio
2. Create the following folders:
    + 1_data
    + 2_code
    + 3_outputs
    + 9_misc
3. Move the data you've been sent into 1_data
</div>
<br/>

We can now view this environment within R Studio - click on 'Files' in the bottom right console.

<img src="../9_Misc/Training_Pics/Files.png" width="600"></img>

<h4 id="General_coding"><b>General Coding Practice</b> (<a href="#Contents">back to contents</a>)</h4>

<h5><b>Objects:</b></h5>

Objects are any 'thing' that you create in R. They're shown in your Environment.

There are a huge number of objects. The code below produces a few of these types of objects:

```{r sec3_1,eval=FALSE}
my_string <- 'DfE'
my_number <- 2017
my_boolean <- TRUE
my_list <- list(1,2,3,4,5)
my_dataframe <- data.frame(var1 = c(1,2,3,4,5),
                           var2 = c("a","b","c","d","e"))
```

There - written your first lines of code in R!

<div class="tip"><b>Tip:</b>

There are a number of different ways you can write names in R:

* snake_case: lower case, separated by underscores
* CamelCase: each word starts with an upper case letter
* kebab-case: lower case, separated by hyphens
</div>

However, we still need to run that code. You'll need to place your cursor somewhere in the line you want to run, or if it's multiple lines highlight them. To initiate the code you can:

* Press CTRL + ENTER
* Click 'Run' in the top right hand corner of the script window

<div class="tip"><b>Tip:</b>

* Double click highlights term
* Triple click highlights line
* Quadruple click highlights entire script
</div>
<br/>
The <span class="code"><-</span> sign is called a get sign. It 'gets' the output from the right hand side and attributes it to the object name.

<div class="tip"><b>Tip:</b>

ALT + - is a shortcut to inputting the get sign.
</div>
<br/>
<div class="activity"><b>Activity A3.3:</b> What does <span class="code">typeof(OBJECT NAME)</span> do?</div>
<br/>
<div class="activity"><b>Activity A3.4:</b> Now save your work in the <span class="code">2_code</span> folder!</div>
<br/>

Writing the following code will remove a specified object:
```{r sec3_2,eval=FALSE}
rm(object_name)
```

Writing the following code will remove all objects:
```{r sec3_3,eval=FALSE}
rm(list = ls())
```

<div class="activity"><b>Activity A3.5:</b> Arguments are the bits of code inside brackets, and if there are multiple arguments they're separated by commas. 

Explain the what the argument inside the second <span class="code">rm</span> in the code above does.</div>
<br/>
<hr/>
<h5><b>Comments:</b></h5>

<div class="activity"><b>Activity A3.6:</b> Type <span class="code">1+1</span> and run it, what comes up in the console? Put a <span class="code">#</span> in front of <span class="code">1+1</span>, what comes up in the console?</div>
<br/>

Comments are really important for annotating code, so that you and others know exactly what the code does and why.

Here we add a description of what <span class="code">setwd()</span> does:

```{r sec3_4,eval=FALSE}
#Remove all objects
rm(list = ls())
```

<div class="tip"><b>Tip:</b>

* CTRL + SHIFT + C comments multiple lines at once
* CTRL + SHIFT + R creates a section, which you can jump between using the dropdown list in the bottom left corner of the script window
</div>
<br/>
<hr/>
<h4 id="Loading_Exploring_Data"><b>Loading and Exploring Data</b> (<a href="#Contents">back to contents</a>)</h4>
<h5><b>Loading in data:</b></h5>
The most common process to load in data is to load in a CSV file.

```{r sec4_1,echo=FALSE}
#Load in data
swfc_16_init <- read.csv("../1_data/swfc_2016_machine_readable.csv")
swfc_16 <- swfc_16_init
```

```{r sec4_2,eval=FALSE}
#Load in data
swfc_16_init <- read.csv("1_data/swfc_2016_machine_readable.csv")
swfc_16 <- swfc_16_init
```

<br/>
<div class="tip"><b>Tip:</b>
Load in and create and initial, raw version of the file, and never do anything to that object. This means if you muck anything up, you'll always have a clean dataset to start again from. This is particularly important when loading in big dataframes, such as those from SQL.
</div>
<br/>
<h5><b>Basic dataframe functions:</b></h5>

There are a number of functions which can be used to gain a summary of data: 

```{r sec4_3,eval=FALSE}
#Basic dataframe exploration functions
summary(swfc_16) #Get a summary of each variable
```
<br/>
<div class="tip"><b>Tip:</b>
This worksheet is built using an add on to R called R Markdown, which integrates code, text, and images. We'll come on to how to create R Markdown documents later, but for now, the box below with a white background and grey border is an output from the above code as it renders in R Markdown. Remember this, it will appear a lot in the worksheet.
</div>
<br/>
```{r sec4_4,echo=FALSE}
#Basic dataframe exploration functions
summary(swfc_16[,c(1:6)]) #Get a summary of each variable
```

```{r sec4_5,eval=FALSE}
head(swfc_16) #Get the top 6 rows
```

```{r sec4_6,echo=FALSE}
head(swfc_16[,c(1:6)])
```

```{r sec4_7,eval=FALSE}
tail(swfc_16) #Get the bottom 6 rows
```

```{r sec4_8,echo=FALSE}
tail(swfc_16[,c(1:6)])
```

```{r sec4_9}
colnames(swfc_16) #Get list of column names
```

<div class="tip"><b>Tip:</b>

Click on the name of a dataframe to open it in a new window.
Click on the arrow to the left of it to see the structure of it, or type <span class="code">str(DATAFRAME_NAME)<span class="code">
</div>
<br/>

We can also change column names using the above function:

```{r sec4_10}
#Identify the column number using colnames(swfc_16) and then specify the string to change it to
colnames(swfc_16)[11] <- "Region"

#...and change it back again
colnames(swfc_16)[11] <- "Government_Office_Region_Name"
```

<hr/>
<h5><b>Selecting certain columns/removing columns:</b></h5>

Selecting certain columns is really helpful for creating subset dataframes. Below we select the school's LA Establishment Code, its unique identifier, and all the columns to do to do with teacher absences:

```{r sec4_11}
teacher_absences <- swfc_16[,c(2,53:55)]
```

Let's break this down:

1. <span class="code">teacher_absences</span> is the name of the new dataframe we're going to create
2. We've seen the get sign before
3. <span class="code">swfc_16</span> is the dataframe we're going to select columns from
4. <span class="code">[]</span> is for selecting a certain element from an object
5. <span class="code">c()</span> stipulates a character string, in this instance a load of numbers
6. <span class="code">x:y</span> means all numbers between and including x and y
7. The comma and  nothing before it signifies that all rows must be included - the format is <span class="code">dataframe[row conditions, column conditions]</span>

Whilst we can use this method to remove columns, we can also remove individual columns using a simpler method. Say for instance we wanted to remove the 2016 LA Establishment Code, the third column:

```{r sec4_12}
swfc_16 <- swfc_16[,-3]
```

<br/>
<h4 id="Manipulating_Dataframes"><b>Manipulating Dataframes</b> (<a href="#Contents">back to contents</a>)</h4>
<h5><b>Conditional selections:</b></h5>

We can select subsets of dataframes based on certain conditions. There are a number of ways to do it, but this method uses functions in the basic R set of functions, known as 'base R':

```{r sec5_1}
#Conditionally select primary schools
swfc_16_pri <- swfc_16[swfc_16$School_Phase == "Primary",]
```

Let's break this down:

1. <span class="code">swfc_16_pri</span> is the name of the new dataframe we're going to create
2. We've seen the get sign before
3. <span class="code">swfc_16</span> is the dataframe we're going to conditionally select rows from
4. <span class="code">[</span>] is for selecting a certain element from an object
5. <span class="code">$</span> is for extracting an element by name, in this instance the <span class="code">School_Phase</span> column
6. <span class="code">=="Primary"</span> signifies that rows must equal <span class="code">Primary</span>
7. The comma and then nothing after it signifies that all columns must be included - the format is <span class="code">dataframe[row conditions, column conditions]</span>

<div class="activity"><b>Activity A5.1:</b> Use conditional selections to create a new dataframe which contains all schools whose school type is an academy. Open the dataframe to see what an academy is actually called in School_Type.</div>
<br/>
<div class="tip"><b>Tip:</b>

After typing the dollar sign when looking for dataframe column names, pause, and a dropdown list will appear.
</div>
<br/>

We can also use selections on numerical variables too:
```{r sec5_2}
swfc_16_male <- swfc_16[swfc_16$Perc_Male_Teachers > 50,]
```

However, we're not limited to just one condition:
```{r sec5_3}
#Conditionally select schools where Pupil:Teacher Ratios are below 20 and above or equal to 10
swfc_16_ptr <- swfc_16[(swfc_16$Pupil_Teacher_Ratio < 20 & swfc_16$Pupil_Teacher_Ratio >=10),]

#Conditionally select schools where Pupil:Teacher Ratios are below 10 or their LA is in Camden
swfc_16_ptr_camden <- swfc_16[(swfc_16$Pupil_Teacher_Ratio < 10 | swfc_16$LA_Name == "Camden"),]
```

<div class="activity"><b>Activity A5.2:</b> Select all schools whose StatutoryLowAge is higher than 5 and have no full time posts vacant (the fourth from last column).</div>

<h5><b>Altering data in dataframes:</b></h5>

Editing dataframes is a key skill. We can edit the data within columns, or create new ones.

Here we edit the <span class="code">Religious_Character</span> to be <span class="code">TRUE</span> or <span class="code">FALSE</span>. The <span class="code">Religious_Character</span> column is a column of factors - strings limited to a certain number of entries. We will first turn it into a column which can contain any string, called a character column.

<div class="tip"><b>Tip:</b>

If a column is a factor, you can see what the different entries are through <span class="code">levels(dataframe$column)</span>.
</div>
<br/>
```{r sec5_4}
#Turn Religious.Character to binary
swfc_16$Religious_Character <- as.character(swfc_16$Religious_Character)

swfc_16$Religious_Character[swfc_16$Religious_Character == 'Does not apply' |
                              swfc_16$Religious_Character == 'None' |
                              swfc_16$Religious_Character == ""] <- FALSE
swfc_16$Religious_Character[swfc_16$Religious_Character != FALSE] <- TRUE
```

This uses boolean logic (<span class="code">TRUE</span> or <span class="code">FALSE</span>). It also uses <span class="code">!=</span> which means does not equal.

We can calculate a new column too. In this instance we'll work out the percentage of teaching staff that are vacancies.

```{r sec5_5}
#Calculate percentage of posts which are vacancies
swfc_16$perc_vacancies <- swfc_16$FT_Vacant_Posts/swfc_16$Tot_Teachers_HC
```

<div class="activity"><b>Activity A5.3:</b> Turn all schools which arent an LA maintained school or a special school into 'Not LA maintained'.</div>
<br/>
<hr/>
<h5><b>Writing data:</b></h5>

<div class="activity"><b>Activity A5.4:</b> The function for writing is <span class="code">write.csv()</span>. Use the help function (<span class="code">?write.csv</span>) to work out what the arguments are for this function</div>

<br/>
<h4 id="dplyr"><b><span class="code">dplyr"</span></b> (<a href="#Contents">back to contents</a>)</h4>

<h5><b>Packages:</b></h5>

One of the great things about R (and lots of other open source programming languages) is that you can add in extra functionality really easy. These extra functions come in the form of packages.

To get a package, we first need to install it. This can be done in the console, as once installed, we don't need to reinstall every time we start a new session of R.

We are going to install a package called <span class="code">dplyr</span>, a package to manipulate data.

```{r sec6_1,eval=FALSE}
install.packages("dplyr")
```

A lot of funny stuff will come up in your Console, ignore it, it's all normal (or should be!).

Once we've installed it, we have to load the package. This we do have to do every time we start a new session of R.

```{r sec6_2,eval=FALSE}
#Load required libraries
library(dplyr)
```

<hr/>
<h5><b>The pipe:</b></h5>

The first feature of <span class="code">dplyr</span> is the pipe: <span class="code">%>%</span>.

The pipe allows you turn code into the format of a recipe, carrying out a series of functions one after another. For example, we could turn the name of the school (<span class="code">School_Name</span>) into a character from a factor, as it is not a categorical variable where the records could take one of a fixed number of entries.

In base R, this would look like:

```{r sec6_3,eval=FALSE}
swfc_16$School_Name <- as.character(swfc_16$School_Name)
```

In <span class="code">dplyr</span> this looks like:

```{r sec6_4,eval=FALSE}
swfc_16$School_Name <- swfc_16$School_Name %>% as.character()
```

The pipe gives a more logical approach - putting the ingredients (<span class="code">swfc_16$Perc_Teachers_QTS</span>) into recipe steps. We don't have to include arguments which specify which object we're operating on, as this is specified when we input the ingredients.

<div class="tip"><b>Tip:</b>

You can shortcut to a pipe by CTRL + SHIFT + M.
</div>
<br/>
<hr/>
<h5><b>Joining:</b></h5>

There are a number of types of joins that <span class="code">dplyr</span> offers. We won't go through them here as this isn't what this course is about, but [this post](http://rstudio-pubs-static.s3.amazonaws.com/227171_618ebdce0b9d44f3af65700e833593db.html) goes through them clearly. We will use a left join - keeping all rows on one dataframe, joining another on a certain variable where they match, and making all rows which don't match 'not applicable'.

We will create a dataframe which details whether a Government Office Region is in London or the Rest of England and then match it to the rest of the School Workforce Census.

```{r sec6_5,eval=FALSE}
#Create dataframe on whether region is in London or Rest of England
ldn_roe <- data.frame(Government_Office_Region_Name = c("East Midlands", "East of England", "Inner London", 
"North East", "North West", "Outer London", "South East", "South West", "West Midlands", "Yorkshire and the Humber"),
ldn_roe = c("RoE","RoE","LDN","RoE","RoE","LDN","RoE","RoE","RoE","RoE"))

#Match to SWFC
swfc_16 <- left_join(swfc_16,LDN_RoE,by="Government_Office_Region_Name")
```

We can also match on column names even if they columns are named differently. But first, we'll  remove the column that we've just added in using the 'select' function.
<br/>
<h5><b>Selecting:</b></h5>

The <span class="code">select</span> function uses column names to select subsets of a dataframe. Individual columns can be selected, separated by columns, or groups of columns, with the starting and ending columns separated by a colon.
<br/>
```{r sec6_6,eval=FALSE}
#Remove new column
swfc_16 <- select(swfc_16,LA_Number:Perc_FT_Temp_Filled_Posts)

#Or using 'the pipe'

swfc_16 <- swfc_16 %>% 
  select(LA_Number:Perc_FT_Temp_Filled_Posts)
```

Now, we can change the name of the first <span class="code">ldn_roe</span> column, and then match again.

```{r sec6_7,eval=FALSE}
#Change name of Government_Office_Region_Name
ldn_roe <- ldn_roe %>% 
  select(Region = Government_Office_Region_Name,
          ldn_roe)

#Match to SWFC
swfc_16 <- left_join(swfc_16,ldn_roe,by=c("Government_Office_Region_Name"="Region"))
```

<hr/>
<h5><b>Pivoting:</b></h5>

Pivoting (grouping data by certain characteristics and then performing certain calculations - counts of each group or averages for each group) is a really popular feature in Excel, and can be replicated using <span class="code">dplyr</span>.

We're going to create two pivot tables:

* Count the number of each type of school
* Calculate the average % of teachers with Qualified Teacher Status for each school type

The image below shows the boxes from the Excel pivot table user interface with the entries to build the pivot table for the first of the list above.

<img src="../9_Misc/Training_Pics/Excel_Pivot.png" width="300"></img>
<br/>
<br/>

```{r sec6_8, eval=FALSE}
#Calculate the number of schools by school type
school_type_count <- swfc_16 %>% #Set the name of the output object and feed in 'the ingredients' - swfc_16 in this instance
  group_by(School_Type) %>% #Recipe step 1: Specifying the variable we want to group the data by
  summarise(Count_Schools = n()) #Recipe step 2: Define what function we want to apply to the grouped data. Here we are doing a simple count - n(). We also specify the name of the new column, in this instance 'Count_Schools'
```

<br/>
<div class="tip"><b>Tip:</b>

To prevent your lines of code being too long you can start new lines after things like <span class="code">%>%</span>, <span class="code">,</span>, <span class="code">=</span>, and <span class="code"><-</span>.

If you go to 'Tools', 'Global Options', 'Code', 'Display' there is an option called 'Show margin' which adds a margin after 80 characters as a default - try not to exceed this.
</div>
<br/>

```{r sec6_9,eval=FALSE}
#Calculate average percentage of qualified teachers per school, grouped by school type
av_qts_schooltype <- swfc_16 %>% #Set the name of the output object and feed in 'the ingredients' - swfc_16 in this instance
  group_by(School_Type) %>% #Recipe step 1: Specifying the variable we want to group the data by
  summarise(Ave_Perc_QTS = mean(Perc_QTS_Teachers,na.rm=TRUE))
    #Recipe step 2: Calculate the average percentage of qualified teachers for each group. The 'na.rm=TRUE' argument does not consider rows where the value is NA.
```

<br/>
<div class="activity"><b>Activity A6.1:</b> Calculate the total number of full time posts which are vacant, by Government Office Region, using the function <span class="code">sum(column,na.rm=TRUE)</span>. Remember to turn the full time posts column into a data type which can be summed.</div>
<br/>
<hr/>
<h5><b>Filtering:</b></h5>
When we looked at conditional selections earlier, we were essentially looking at a way of filtering data. There's a neater way of doing this with <span class="code">dplyr</span>:

```{r sec6_10, eval=FALSE}
#Select all schools in Inner and Outer London
swfc_16_lon <- swfc_16 %>% 
  filter(grepl("London",Government_Office_Region_Name)) #The filtering function is unsurprisingly called 'filter()'
    #Here, we're using a function called grepl, which finds all rows where the Government_Office_Region_Name column contains the string 'London'.
```

<br/>
<div class="activity"><b>Activity A6.2:</b> Use <span class="code">!is.na()</span> to filter out all schools without a value for the percentage of teachers who are qualified. Explain what <span class="code">!is.na()</span> does.</div>

<hr/>

<h5><b>Mutating:</b></h5>
The <span class="code">mutate()</span> function allows you to alter data in the dataframe, as we did a few sections ago. Let's take the code above where we calculated the number of schools of each type of school, bolt on some more recipe steps, and calculate the percentage of schools in each group.

```{r sec6_11,eval=FALSE}
#Calculate the percentage of schools by school type
school_type_count <- swfc_16 %>%
  group_by(School_Type) %>%
  summarise(Count_Schools = n()) %>% 
  mutate(Perc_Schools = Count_Schools/sum(Count_Schools))
```

Let's break this down:

1. We've used the mutate function
2. We've created a new column called <span class="code">Perc_Schools</span>
3. <span class="code">Perc_Schools</span> equals the count for each school type, divided by the total number of schools, calculated using <span class="code">sum()</span>

We can also mutate a column without creating a new column:

```{r sec6_12,eval=FALSE}
#Calculate the percentage of schools by school type
school_type_count <- swfc_16 %>%
  group_by(School_Type) %>%
  summarise(Count_Schools = n()) %>% 
  mutate(Perc_Schools = Count_Schools/sum(Count_Schools)) %>% 
  mutate(Perc_Schools = round(Perc_Schools*100,1)) #Multiply Perc_Schools by 100 to get a percentage, and round to 1 decimal place.
```

<br/>
<div class="activity"><b>Activity A6.3:</b> The big one - use <span class="code">dplyr</span> to find out what percentage of secondary school (not including all through school) teaching assistants the East of England has. These are the functions you'll need to run:

1. A filter
2. Pivoting using a sum
3. Mutating
4. Filtering on 'East of England'
5. Selecting the value column
6. Using <span class="code">as.numeric()</span> to return just one number

Hint: Write each step of code, run it, check it works, and then add the next recipe step in.
</div>
<br/>
<h4 id="Graphs"><b>Graphs</b> (<a href="#Contents">back to contents</a>)</h4>
<h5><b><span class="code">ggplot2</span>:</b></h5>
Another package in the <span class="code">tidyverse</span> is <span class="code">ggplot2</span>, used for plotting anything from graphs to maps.

R has a function built into it to plot graph, unsurprisingly called <span class="code">plot()</span>. However, it's limited compared to <span class="code">ggplot2</span>, which is part of the <span class="code">tidyverse</span> package. 
<br/>
<br/>
<div class="activity"><b>Activity A7.1:</b> Install either the <span class="code">ggplot2</span> package or the <span class="code">tidyverse</span> package of packages, of which <span class="code">ggplot2 is one</span>. Remember to load it up using <span class="code">library()</span>!
</div>
<br/>
The main function in <span class="code">ggplot2</span> is <span class="code">ggplot</span>, which stands for the 'grammar of graphics'. The 'grammar of graphics' relates to the three elements that makes up a graphical visualisation:

* A dataset from which the visualisation is built
* Visual marks that represent the data
* A coordinate system - a grid on which the data is plotted

In this section we'll look at how to plot three different types of graph:

* Scatter plots
* Bar charts
* Line graphs

We'll also look at how to show how data of different groups can be displayed and how to alter the style of graphs.

First, let's look at the basic functions:
```{r sec7_1,eval=FALSE}
ggplot(dataset,aes(x,y)) + 
  geom_*() +
  coords_*() +
  styles() +
  styles()
```

Let's break this down:

* The first argument of the main function, <span class="code">ggplot</span>, is the dataset from which the data will come from (the first of our graphical elements)
* The second argument, the aesthetics, in the <span class="code">ggplot</span> function are the specific columns within the dataset which make up the x and y axis (also part of the first of the graphical elements)
* The <span class="code">geom_*</span> functions, where the asterisk details the type of visualisation, is used to detail how the visual marks are displayed (the second of the elements)
* The <span class="code">coords_*</span> functions are optional in defining the coordinate system, but if no functions are included, a standard x-y grid will be produced (the third, and least commonly used of the elements)
* Further multiple and optional styles can be added on

Each of these are joined together with plus signs.
<hr/>
<h5><b>Scatter plots:</b></h5>
A scatter plot is a plot of points where each point is defined by a dataset's entry's for two variables, creating x and y axes.

Here we'll create a scatter plot (or <span class="code">geom_point()</span> as it is known in <span class="code">ggplot</span>) to compare the total workforce in a school and the total teaching workforce.

```{r sec7_2,warning=FALSE}
ggplot(swfc_16,aes(Tot_Workforce_HC,Tot_Teachers_HC)) +
  geom_point()
```
<br/>
<br/>
<div class="activity"><b>Activity A7.2:</b> Explain the arguments in this graph.
</div>
<br/>
<hr/>
<h5><b>Bar charts:</b></h5>
We can use bar charts to do simple counts of the number of observations belonging to each level. In the example below we use the <span class="code">geom_bar()</span> function to count the number of schools of each school type:
```{r sec7_3}
ggplot(swfc_16,aes(School_Type)) +
  geom_bar()
```
<br/>
<br/>
<div class="activity"><b>Activity A7.3:</b> What's different about the <span class="code">aes()</span> function and why?
</div>
<br/>
However, as well as counts we can use bar charts to display the values within the column of a dataframe. Here we calculate the average percentage of teachers with qualified teacher status for each school type.
```{r sec7_4}
ggplot(swfc_16 %>% group_by(School_Type) %>% summarise(ave_perc_qts = mean(Perc_QTS_Teachers,na.rm=TRUE)),
       aes(School_Type,ave_perc_qts)) + 
  geom_bar(stat="identity")
```
<br/>
Let's break down the arguments:

* The first argument within <span class="code">ggplot()</span> is a <span class="code">dplyr</span> script to create a dataframe which contains each school type and its average percentage of qualified teachers. This negates the need to, every time, create a named dataframe.

<div class="activity"><b>Activity A7.4:</b> Highlight the first argument and run it.</div>
<br/>

* The <span class="code">aes()</span> function contains two arguments this time - the x-axis and the y-axis. We need to define a y-axis because we're going to be using values from a column, not just counts.
* The <span class="code">geom_bar()</span> function contains an argument, <span class="code">stat='identity'</span>, which informs the plot that it's to use the values from a column (in this instance the <span class="code">ave</span> column created in the first argument of <span class="code">ggplot()</span>).

<hr/>
<h5><b>Line graphs:</b></h5>

<div class="activity"><b>Activity A7.5:</b> Adjust the code above for the bar graph to produce a line graph:

* Replace <span class="code">geom_bar(stat="identity")</span> with <span class="code">geom_line()</span>
* Change the columns used to see how the TA:Teacher ratio (<span class="code">TA_Teacher_Ratio</span>) varies with the total number of teachers in a school (<span class="code">Tot_Teachers_HC</span>).

</div>

<br/>

A word of warning with line graphs though: you can use bar charts and line graphs to display changes between discrete numerical data (e.g. 1,2,3,4,5), but you should not use a line graph to display changes between categorical data (e.g. primary schools, secondary schools, special schools). This is because a line graph implies some sort of continuous variation, so each mark has a 'distance' from the previous (e.g. the distance between 2 and 1 is 1), but there's no 'distance' between primary school and secondary school.

```{r sec7_5,warning=FALSE}
ggplot(swfc_16 %>% group_by(Tot_Teachers_HC,School_Type) %>% summarise(ave_ta_teacher_ratio = mean(TA_Teacher_Ratio,na.rm=TRUE)),
       aes(Tot_Teachers_HC,ave_ta_teacher_ratio)) + 
  geom_line()
```
<hr/>
<h5><b>Displaying a third variable:</b></h5>
We can use ggplot to plot three variables, not just two on the x and y axes. This allows the viewer to get a more detailed breakdown of the data, without having to produce multiple graphs.

There are three different arguments which can be added to the aesthetic function (as they're going to change how the graph looks), depending on what type of graph is being produced:

* <span class="code">fill=</span> is used for bar graphs - this splits up each bar with different colours related to the proportion of each category making up that bar
* <span class="code">col=</span> is used for line graphs - this creates lines of different colours for each different category to show how it varies
*  <span class="code">size=</span> is used for scatter plot - the size of each point relates to the value in the column

In all of these arguments, after the equals sign comes the variable name that we want to plot.

Here's an bar chart example which uses <span class="code">fill</span> which shows the proportions of each type of school which make up each region.
```{r sec7_6,echo=FALSE,warning=FALSE}
ggplot(swfc_16,aes(Government_Office_Region_Name,fill=School_Type)) +
  geom_bar()
```

<div class="activity"><b>Activity A7.6:</b> Use <span class="code">col</span> to adapt the line graph above to show how different each different school type's TA:Teacher ratio varies with size of school.
</div>
<br/>

Finally, we're going to use <span class="code">size</span> to show a third variable on a scatterplot.

<div class="activity"><b>Activity A7.7:</b> Use the <span class="code">group_by</span> and <span class="code">summarise</span> functions in <span class="code">dplyr</span> to create a dataframe which has four columns:

* Government Office Regions
* The average pay (<span class="code">Mean_Gross_Salary_All_Teachers_Sterling</span>) for each of those regions
* The average percentage of teachers receiving allowances (<span class="code">Perc_Receive_Allowance_Qual_Classroom_Teachers</span>) in each region
* The number of schools in each region (use <span class="code">n()</span>)

Your code in the <span class="code">summarise</span> function will look something like:
```{r sec7_7,eval=FALSE}
summarise(var1_name = mean(variable1,na.rm=FALSE),
          var2_name = mean(variable2,na.rm=FALSE),
          var3_name = n())
```
</div>
<br/>
<div class="activity"><b>Activity A7.8:</b> Pop your dataframe code from the activity above into a <span class="code">ggplot</span> function, and create a scatter plot with the <span class="code">col</span> argument as the region and the <span class="code">size</span> argument as the number of schools in that region.

It may seem like it should be <span class="code">fill</span> not <span class="code">col</span> for colouring points, but remember that a point shouldn't really have a size - it's an exact location, so there's nothing to fill!
</div>
<hr/>
<h5><b>Styles:</b></h5>
So, we've produced a number of graphs now, but they're not the best formatted in places...

Fortunately, one of <span class="code">ggplot</span>'s major selling points is that it's really versatile with the formatting that can be done.

Here are a few handy functions, all of which are added with a plus sign after you've detailed what plot you want:

* <span class="code">coord_flip()</span> flips the coordinates, so the x axis is on the y axis and vice versa. This is really useful for bar graphs, to prevent labels overlapping
* <span class="code">ggtitle()</span> allows you to specify a chart title - the argument within this function is enclosed in quotes and details what title is required
* <span class="code">xlab</span>/<span class="code">ylab</span> specify the x and y axis labels respectively and again the argument, which is the label, is enclosed in quotes
* <span class="code">theme_minimal()</span> removes the grey background, which immediately makes it look nicer!
* <span class="code">xlim</span>/<span class="code">ylim</span> specifies the limits for continuous axes on the x and y axes respectively. They take two arguments - the lower limit and the upper limit, separated by a comma.

<div class="activity"><b>Activity A7.9:</b> Apply all of these functions to the graphs you've previously produced.
</div>

<h4 id="Stats_Ops"><b>Statistical Operations</b> (<a href="#Contents">back to contents</a>)</h4>

Easily drilling down into data is one of R's most powerful functions. As we would with Excel, we can use a number of functions to gain a better understanding of the data.
<hr/>
<h5><b>Maximum, Minimum, and Range:</b></h5>

One of the key checks to do on a dataset when loading data in is what extreme values are in each variable:

* The minimum
* The maximum
* The range

<div class="tip"><b>Tip:</b>

Put closing delimiters* on a new line - it's easier to see which opening delimiter it corresponds to.

*<span class="code">()</span>, <span class="code">{}</span>, <span class="code">[]</span>

</div>
<br/>
Now, we can calculate the minimum and maximum for any column we require:

```{r sec8_1, eval=FALSE}
min(swfc_16$Pupil_Teacher_Ratio)
max(swfc_16$Pupil_Teacher_Ratio)
```

<br/>
<div class="activity"><b>Activity A8.1:</b> It's coming up with <span class="code">NA</span>. What's the argument in <span class="code">min</span> or <span class="code">max</span> that we need to add in to return a result?
</div>
<br/>

We could also write this using the pipe:

```{r sec8_2, eval=FALSE}
swfc_16 %>% 
  select(Pupil_Teacher_Ratio
         ) %>% 
  min(ARGUMENT_IN_HERE
      )

swfc_16 %>%
  select(Pupil_Teacher_Ratio
         ) %>%
  max(ARGUMENT_IN_HERE
      )
```

These two functions are really useful for identifying extreme values and outliers - potentially values which are incorrect or shouldn't be there.

We can use another function, similar to <span class="code">min</span> and <span class="code">max</span>, called <span class="code">range</span>.

<br/>
<div class="activity"><b>Activity A8.2:</b> Pick a variable and calculate the range. Think about the arguments you need to use.
</div>

<br/>
<div class="tip"><b>Tip:</b>

Statistical functions nearly always need to have <span class="code">NA</span> values removed from the object they're operating on.

</div>
<hr/>

<h5><b>Averages:</b></h5>

There are two averages we can calculate:
<ol>
  <li><b>Mean:</b> This is the 'average' that we're used to - add the values up and divide them by the number of values</li>
  <li><b>Median:</b> Line them all up in order, count to the middle value (if its an even number of values, go for halfway between the two middle values)</li>
</ol>

Let's apply each of these to a subset of the main dataset.

Mean:
```{r sec8_3, eval=FALSE}
#The mean of the total school workforce for primary schools
swfc_16 %>%
  filter(School_Phase == 'Primary') %>% 
  group_by(School_Phase) %>% 
  summarise(Ave = mean(Tot_Workforce_HC,na.rm=TRUE))
```

Median:
```{r sec8_4, eval=FALSE}
#The median of the total school workforce for primary schools
swfc_16 %>%
  filter(School_Type == 'Academies') %>% 
  group_by(School_Type) %>% 
  summarise(Ave = median(Tot_Workforce_HC,na.rm=TRUE))
```

<h5><b>Correlations:</b></h5>

<div align = "center"><img src="../9_Misc/Training_Pics/Correlation.png" width="500"></img></div>

We can calculate correlations between 2 or more values.

Let's just start with two variables:
```{r sec8_5}
#Base R
cor(swfc_16[,c(15,16)],use="complete.obs")

#Pipes
swfc_16 %>% select(StatutoryLowAge,StatutoryHighAge)%>% cor(use="complete.obs")

#use="complete.obs" means only use the observations where the data is present in both columns
```

<br/>
<div class="activity"><b>Activity A8.3:</b> Create an object (a correlation matrix) which has the correlations for all the columns between <span class="code">StatutoryLowAge</span> and <span class="code">Tot_TAs_HC</span>. Assign it to an object name.
</div>
<hr/>
<h5><b>Significance Testing:</b></h5>

This isn't a stats course, but significance testing is a really handy technique for analysing data - the first step in learning statistical techniques in a data analyst's/scientist's toolkit, and can be relatively easily executed in R.

In practical terms, significance testing is quantifying how confident we are two groups are different to one another.

Suppose we wanted to test whether primary schools had significantly different total workforces to the school population overall.

```{r sec8_6, eval=FALSE}
t.test(swfc_16 %>% filter(School_Phase == "Primary"
                          ) %>% select(Tot_Workforce_HC),
       mu = mean(swfc_16$Tot_Workforce_HC,na.rm=TRUE),
       alternative = "less")
t.test(swfc_16[swfc_16$School_Phase == "Primary",17],
       mu = mean(swfc_16$Tot_Workforce_HC,na.rm=TRUE),
       alternative = "less")
```
Let's break the input down:
<ul>
  <li><span class="code">t.test()</span>: The technique to test for a significant difference is called a T-test - in this instance we're carrying out a 'one-tail' T-test, which in this instance means checking whether the average of a sample significantly differs from the average of the entire population.</li>
  <li><b>Argument 1:</b> The first argument is the sample that we want to the population against. In this instance it's primary schools.</li>
  <li><b>Argument 2:</b> <span class="code">mu</span> is the average of the population.</li>
  <li><b>Argument 3:</b> We want to test whether the sample average is 'less' than population average. This could also be 'greater'.</li>
</ul>
```{r sec8_7,echo=FALSE}
t.test(swfc_16 %>% filter(School_Phase == "Primary") %>% select(Tot_Workforce_HC),
mu = mean(swfc_16$Tot_Workforce_HC,na.rm=TRUE),
alternative = "less")
```
Now let's break the output down (in reverse order from how it's displayed):
<ul>
  <li><b>Mean of x:</b> This is the average of the sample: 46.5287.</li>
  <li><b>Confidence intervals:</b> 95% of the time (i.e. 19 out of 20 times), the average of any random sample of the overall population will be outside the confidence intervals. Here, because we're only checking whether the sample's average than the population's average, we only need a confidence interval above the mean: 46.84931.</li>
  <li><b>p-value:</b> To be confident that there is a significant difference, this number needs to be less than 0.05 (i.e. only 1 time out of 20 will a random sample of primary schools we take from the population be smaller than the upper confidence interval.</li>
</ul>

<b>Simple?!?</b>

<br/>
<div class="activity"><b>Activity A8.4:</b> Test whether schools in Camden LA District have a significantly higher percentage of vacant posts (column name is <span class="code">FT_Vacant_Posts</span>) than England as a whole, using a t-test.

Repeat for lower.
</div>

<br/>

As well as comparing a sample to a population we can compare two samples. What we are doing is testing whether the difference of the averages of two samples is <b>significantly different</b> to zero, i.e. there is a difference.

In this example we're going to test whether primary schools have a significantly different percentage of teachers who are male to schools that have a phase of 'All Through'.
```{r sec8_8,eval=FALSE}
t.test(Perc_Male_Teachers ~ School_Phase, 
       data = (swfc_16 %>% filter(School_Phase == "Primary" |
                                    School_Phase == "All Through") %>% 
                 select(School_Phase,
                        Perc_Male_Teachers)))
```
Let's break the input down:
<ul>
  <li><span class="code">t-test</span>: As above</li>
  <li><b>Argument 1:</b> This contains the variable that we're going to compare the groups on (percentage of teachers that are male), and the characteristic that defines the groups (phase). But there's more than one phase of school I hear you say...</li>
  <li><b>Argument 2:</b> Fear not. In the second argument we use some dplyr to do some filtering. We only select schools that are primary or all through, and we only select the school phase and percentage of teachers that are male columns.
</ul> 
```{r sec8_9,echo=FALSE}
t.test(Perc_Male_Teachers ~ School_Phase, 
       data = (swfc_16 %>% filter(School_Phase == "Primary" |
                                    School_Phase == "All Through") %>% 
                 select(School_Phase,
                        Perc_Male_Teachers)))
```
Now let's break the output down:
<ul>
  <li><b>Welch:</b> Dunno who Welch is, but their t-test is the standard one for testing two samples</li>
  <li><b>Group means (at the bottom):</b> These are the means of the two samples that we're comparing</li>
  <li><b>Confidence intervals:</b> 95% of the time (i.e. 19 out of 20 times), the average of any random samples taken from each of the groups (primary and all through) will have a difference in their averages of between 15.56238 and 18.51366. Both of those numbers are above 0, so this is looking good...</li>
  <li><b>p-value:</b> Again, to be confident that there is a significant difference, this number needs to be less than 0.05 (i.e. only 1 time out of 20 will random samples from primary schools and all through schools be outside the confidence intervals above)</li>
</ul>
<br/>
<div class="activity"><b>Activity A8.5:</b> Test whether schools in Camden and Northumberland LA Districts have significantly different percentage of vacant posts (column name is <span class="code">FT_Vacant_Posts</span>) than England as a whole, using a two sample t-test.
</div>
<br/>
<div class="tip"><b>Tip:</b>

For more info on t-tests, go to <a href="http://www.dummies.com/education/math/statistics/how-to-test-for-an-average-difference-using-the-paired-t-test/">this page</a> on dummies.com.

Also, try out <a href="https://www.graphpad.com/quickcalcs/ttest1.cfm">this page</a> for an interactive two sample t-test calculator if you want a bit more practice.

</div>
<br/>

<h4 id="Iteration"><b>Iteration</b> (<a href="#Contents">back to contents</a>)</h4>
One of the most powerful uses of any programming language is its ability to do a task over and over again really quickly - this is known as iteration.
<div class="tip"><b>Tip:</b>
Iteration isn't actually the most efficient way of writing code, because it processes each item it iterates over one at a time. A more efficient way to process code is to 'vectorise' your code - this means writing code to process all the items at once. We've already done this when we've been manipulating columns of data in one go - we could have written an iterative function to go over each item in the column and manipulate it. 
</div>
That said, iteration is a really important process to learn, because it helps you understand the sort of 'decisions' a computer will make in the background when executing code.

There are three types of iterative function that we'll look at:

* An <span class="code">if</span> statement - a function that will do one thing if a condition is met or is true, and another thing is that condition is not met or is false
* A <span class="code">for</span> loop - a function that will repeat a task for every item in a list or a certain number of iterations
* A <span class="code">while</span> -  function that will repeat a task for as long as a condition is met or is true

All of the functions here take a similar format:
```{r sec9_1,eval=FALSE}
function(condition to be met){
  action to be carried out if condition is met #Note how it has to be indented
}
```
<hr/>
<h5><b><span class="code">if</span> statements</b></h5>
As mentioned above, <span class="code">if</span> statements are for carrying out an action if a condition is met or is true.

For example, say we were trying to create a recreate whether a fictitious teacher was male or female, if we knew the probability that a teacher was male, we could build an <span class="code">if</span> statement that said:

1. Generate a random number between 0 and 1
2. If that number is less than or equal to the probability that a teacher is male, then say our fictitious teacher is male
3. If that number is more than the probability that a teacher is male, then say our fictitious teacher is female

First, let's work out the probability that a teacher is male. This is the average percentage of male teachers divided by 100, to make it a probability.
```{r sec9_2,eval=FALSE}
prob_male <- swfc_16$Perc_Male_Teachers %>% mean(na.rm = TRUE)/100
```

Now, let's generate our random number using the <span class="code">runif</span> function.
```{r sec9_3,eval=FALSE}
rand_num <- runif(1)
```

Now let's write our if statement.
```{r sec9_4,eval=FALSE}
if(rand_num<=prob_male){
  print("M")
}
```

So now if our random number is less than or equal to the probability a teacher is male that it will print 'M'. However, if it's over the probability, nothing will happen.

To ensure something does happen we can use the <span class="code">else</span> function, which will execute an action if the condition is not met.
```{r sec9_5,eval=FALSE}
if(rand_num<=prob_male){
  print("M")
}else{
  print("F")
}
```

<div class="activity"><b>Activity A9.1:</b> How could we streamline the code we've just written by replacing object names?
</div>
<hr/>
<h5><b><span class="code">for</span> loops</b></h5>
A <span class="code">for</span> loop - a function that will repeat a task for every item in a list or a certain number of iterations. Say we wanted to create a fictitious school which contained 10 teachers, we could write a <span class="code">for</span> loop that for 10 iterations repeated the <span class="code">if</span> statement above.
```{r sec9_6,eval=FALSE}
for(i in 1:10){
  if(runif(1)<=prob_male){
    print("M")
  }else{
    print("F")

  }
}
```

Let's break this down the <span class="code">for</span> loop argument:

1. The <span class="code">i</span> is the name of an object that will take a different value at each iteration (1st iteration, 2nd iteration, etc) of the for loop
2. <span class="code">in 1:10</span> details the different values <span class="code">i</span> will take: 1st iteration - i=1, 2nd iteration i=2, etc.
3. The action to execute at each stage between the curly braces, which in this instance is the <span class="code">if</span> statement from above

<div class="activity"><b>Activity A9.2:</b> Adapt the <span class="code">for</span> loop above to create an empty object and at each iteration add the result from the <span class="code">if</span> statement to that object. The functions you'll need are below:
```{r sec9_7,eval=FALSE}
#For creating an empty object
character(0)

#For joining values to an existing object
c(object,value)
```
</div>

<hr/>
<h5><b><span class="code">while</span> loops</b></h5>
A <span class="code">while</span> loop while perform an action for as long as the condition specified in the function's argument is true.

<div class="activity"><b>Activity A9.3:</b> Write the function below out and run it. As 2 while always be greater than 1 what is going to happen?
<br/>
```{r sec9_8,eval=FALSE}
while(1<2){
  print("This is going to take a while...")
}
```
</div>
<br/>
<div class="tip"><b>Tip:</b> Stop a bit of code from running by clicking on the red stop sign in the top right hand corner of the console.
</div>
<br/>
Typically, a while loop will look like this:
```{r sec9_9,eval=FALSE}
object <- starting_value
while(condition_of_object){
  action
  object <- change_value_of_object
}

#For example
i <- 1
while(i<5){
  print(paste0("This is a while loop, we're at iteration ", as.character(i)))
  i<-i+1
}
```
<div class="tip"><b>Tip:</b> <span class="code">paste0()</span> is a really useful function that glues strings together. It's different to <span class="code">c()</span> in that it turns multiple strings into one string, whereas <span class="code">c()</span> turns them into a vector of multiple strings.
</div>
<br/>
<div class="activity"><b>Activity A9.4:</b> Add 3 <span class="code">while</span> loops after your <span class="code">for</span> loop above so that while <span class="code">i</span> equals 1 you add 'Headteacher' to an object, while <span class="code">i</span> is less than 5 you add 'Senior Leader' to the same object, and while <span class="code">i</span> is greater or equal to 5 you add 'Classroom Teacher' to the same object.

Once this has run put the gender object and the object denoting the seniority of the teacher into a dataframe called <span class="code">my_school</span> with the column headings as <span class="code">gender</span> and <span class="code">grade</span>.
</div>
<hr/>
<h5><b>How could we use loops?</b></h5>
Loops are really useful for building models of systems, to use probabilities (as we did with the gender probabilities) to predict how entities (called agents in modelling) will behave in a system. These models can be run multiple times and the outputs recorded each time to give a distribution of how likely each outcome is to occur based on different behaviours along the modelled actions.
<br/>
<h4 id="Functions"><b>Functions</b> (<a href="#Contents">back to contents</a>)</h4>
We've used a lot of functions up until now, and understand the format of a function, with the function name and then the arguments inside the brackets. It essentially takes the form:
```{r sec10_1,eval=FALSE}
verb(noun,adverbs)
```
Where the verb is the thing we want to do, the noun (as the first argument) is the object we want to do it to, and the adverbs (as the subsequent arguments) are the descriptions of how we want to do it.

However, there's going to come a time when we want to do the same thing again and again, to a lot of different objectives, and there won't be a specific function to write it. Don't worry though, you can do write your own functions.
<hr/>
<h5><b>Writing functions</b></h5>
A function is comprised of three parts:
```{r sec10_2,eval=FALSE}
function_name <- function(function_argument1,function_argument2,etc){
  function_actions
}
```
So, a function that divides an object by 100 looks like this:
```{r sec10_3,eval=FALSE}
my_func <- function(x){
  x/100
}
```
Here <span class="code">x</span> is the noun that we're doing something to. To create the function, simply run that code.

<div class="activity"><b>Activity A10.1:</b> Use <span class="code">mutate</span> and multiply <span class="code">Perc_PT_Teaching_Staff_</span> by 100 in a new column called <span class="code">perc_pt_test</span>.
</div>
<br/>
<div class="activity"><b>Activity A10.2:</b> Remember the code from the iteration section on deciding whether a fictional teacher was male or female?
```{r sec10_4,eval=FALSE}
if(rand_num<=prob_male){
  print("M")
}else{
  print("F")
}
```
Turn that into a function, with the random number as the 'noun'. 

Once you've written it, run it with a few different numbers in the argument.
</div>
<br/>

It's also really handy for producing graphs when we want to filter them by different categories. Say we wanted to look at a histogram of the total school workforce, to get an idea of the distribution of school sizes in a particular region, we could make a graph like this (with Inner London as an example):
```{r sec10_5,warning=FALSE,message=FALSE}
ggplot(swfc_16 %>% filter(Government_Office_Region_Name == 'Inner London'),
     aes(Tot_Workforce_HC)) +
geom_histogram() +
  ggtitle('Distribution of school size in Inner London')
```

However, 'Inner London' could be any one of the 9 other regions in England - we could vary this value. By varying it we are making it a parameter - a value in our input code that can change.

We can produce exactly the same output by replacing the string 'Inner London' with an object name, and creating that object before we create the graph (remember the <span class="code">paste0</span> function that we used in the iteration section).
<br/>
```{r sec10_6,warning=FALSE,message=FALSE}
region_name <- 'Inner London'

ggplot(swfc_16 %>% filter(Government_Office_Region_Name == region_name),
     aes(Tot_Workforce_HC)) +
geom_histogram() +
  ggtitle(paste0('Distribution of school size in ',region_name))
```

<div class="activity"><b>Activity A10.3:</b> Using the code above, create a function which you could put in any region name, and as long as that region is correct, the function produces a graph.
</div>
<hr/>
<h5><b>Applying functions repetitively</b></h5>
Writing a lot of code get boring and laborious. Writing a lot of code that does the same thing again and again gets really boring and laborious. It can also lead to errors - if you copy and paste code enough times eventually you'll make a mistake, which could lead to incorrect analysis.

However, as already mentioned, if you're doing something again and again, then building a function is really useful. 
Suppose we do want to create graphs of all 10 regions, using the code above? We have the function to produce a graph, what we need now is to work out how to repeat the graph again and again, changing the region parameter.

We could use a <span class="code">for</span> loop, but remember that's not the most effective way. We want to 'vectorise our code'.

A function called <span class="code">lapply</span> applies a function to a list of objects.
<br/>
<div class="activity"><b>Activity A10.3:</b> The <span class="code">Government_Office_Region_Name</span> column is a factor column - use <span class="code">levels()</span> to generate a list of the different possible entries to that column
</div>
<br/>
The <span class="code">lapply</span> function works in the following way:
<br/>

```{r sec10_7,eval=FALSE}
lapply(multiple_objects_to_apply_function_to,function(argument_name) specific_function_to_apply(argument_name))
```
The word <span class="code">function</span> at the start of the second argument specifies that you're about to write a function name, and essentially says 'make each object in the list in the first argument the value of <span class="code">argument_name</span> and apply the specific function to it'.

You can choose any string you like for <span class="code">argument_name</span>, as long as it's the same in both places.
<br/>
<div class="activity"><b>Activity A10.3:</b> Use <span class="code">lapply</span> to print a graph showing the distribution of school sizes in the Plot pane for every single region in England.
</div>
<br/>
We can also use lapply to do the same thing to data in multiple columns. The difference here is that we want to turn the outputs of the <span class="code">lapply</span> into an object. That object just so happens to be the same thing that goes in to the first argument in <span class="code">lapply</span>. So if we wanted to turn all the columns with 'Perc' in the column title, that is those columns that are a percentage, from a number out of 100 to a number out of 1, by dividing by 100, we'd apply the following code:
<br/>
```{r sec10_8,eval=FALSE}
swfc_16[,grep("Perc", colnames(swfc_16))] <- lapply(swfc_16[,grep("Perc", colnames(swfc_16))],function(x) my_func(x))
```

Let's break this down:

* <span class="code">swfc_16[,grep("Perc", colnames(swfc_16))]</span> are all the columns in <span class="code">swfc_16</span> which contain 'Perc'. The function <span class="code">grep</span> finds all the columns which contain the substring 'Perc'.
* Within <span class="code">lapply</span>, the first argument is the same set of columns - we're essentially doing an update on those columns
* The function we're applying is <span class="code">my_func</span>, which divided the object by 100

<br/>
<div class="activity"><b>Activity A10.3:</b> Use <span class="code">lapply</span> to turn columns 6 to 10 (<span class="code">swfc_16[,grep("Perc", c(6:10))]</span>) into character columns, from factor columns.
</div>
<br/>
<h4 id="Maps"><b>Maps</b> (<a href="#Contents">back to contents</a>)</h4>
Maps in R are best plotted using <span class="code">ggplot</span> - which is good, because we already know how to use that! However, the new thing about maps is the sort of data we'll be using - as well as having data about certain variables, this data has a location attached to it too.
<hr/>
<h5><b>Geospatial data</b></h5>

```{r,eval=FALSE}
cities <- "../1_data/SHPs/england_cities.shp" %>% readOGR()

england <- "../1_data/SHPs/England_LA_2016.shp" %>% 
  readOGR()

plot(england) +
  plot(cities,add=T,col="red")

cities <- spTransform(cities, CRS("+init=epsg:27700"))

england <- "../1_data/SHPs/England_LA_2016.shp" %>% 
  readOGR() %>% 
  fortify(region="LA15NM") %>% 
  as.tbl() %>% 
  dplyr::select(Easting = long,
                Northing = lat,
                LAD16NM = id,
                group)

cities <- "../1_data/SHPs/england_cities.shp" %>% 
  readOGR() %>%
  spTransform(CRS("+init=epsg:27700")) %>% 
  data.frame() %>% 
  select(City,
         Easting = coords.x1,
         Northing = coords.x2)

ggplot()+
  geom_polygon(data=england,
               aes(Easting,Northing,group=group),
               col="grey",
               fill=NA) +
  geom_point(data=cities,
             aes(Easting,Northing),
             col="red") +
  coord_equal() +
  theme_minimal() +
  geom_text(data=cities,
            aes(Easting,Northing,label=cities$City),
            check_overlap = TRUE,
            col="blue",
            hjust = 1.1,
            vjust=0.3)
```
<h5><b>Point maps</b></h5>
```{r,eval=FALSE}
Wiltshire <- "../1_Data/SHPs/England_LA_2016.shp" %>% 
  readOGR() %>% 
  subset(LA15NM == "Wiltshire") %>% 
  fortify(region="LA15NM") %>% 
  as.tbl() %>% 
  dplyr::select(Easting = long,
                Northing = lat,
                LA15NM = id,
                group)
  
ggplot() +
  geom_polygon(data=Wiltshire,aes(Easting,Northing),col="grey",fill=NA) +
  coord_equal() +
  theme_minimal() +
  theme(axis.line=element_blank(),
        axis.text.x=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks=element_blank(),
        axis.title.x=element_blank(),
        axis.title.y=element_blank(),
        panel.background=element_blank(),
        panel.border=element_blank(),
        panel.grid.major=element_blank(),
        panel.grid.minor=element_blank(),
        plot.background=element_blank(),
        legend.title=element_blank())

wiltshire_schools <- "../1_Data/wiltshire_schools.csv" %>% read_csv()

wiltshire_schools %>% write_csv("wiltshire_schools.csv")

ggplot() +
  geom_point(data=wiltshire_schools,aes(Easting,Northing,size=Tot_Workforce_HC,
                                        col=School_Phase)) +
  geom_polygon(data=Wiltshire,aes(Easting,Northing),col="grey",fill=NA) +
  coord_equal() +
  theme_minimal() +
  theme(axis.line=element_blank(),
        axis.text.x=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks=element_blank(),
        axis.title.x=element_blank(),
        axis.title.y=element_blank(),
        panel.background=element_blank(),
        panel.border=element_blank(),
        panel.grid.major=element_blank(),
        panel.grid.minor=element_blank(),
        plot.background=element_blank(),
        legend.title=element_blank())
```
<h5><b>Chloropleth maps</b></h5>
```{r,eval=FALSE}
library(rgdal)

England <- readOGR("../1_data/SHPs/England_Regions.shp")
plot(England)

region_ave_salary <- "../1_data/region_ave_salary.csv" %>% 
  read_csv()

Reg_England_df <- England %>% 
  fortify(region="rgn16nm") %>% 
  as.tbl() %>% 
  dplyr::select(Easting = long,
                Northing = lat,
                Region = id,
                group) %>% 
  left_join(region_ave_salary,c("Region"="Government_Office_Region_Name"))

ggplot() +
  geom_polygon(data=Reg_England_df,aes(Easting,Northing,
                                       group=group,
                                       fill=ave_sal),
               col="white") +
  coord_equal() +
  theme_minimal() +
  theme(axis.line=element_blank(),
        axis.text.x=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks=element_blank(),
        axis.title.x=element_blank(),
        axis.title.y=element_blank(),
        panel.background=element_blank(),
        panel.border=element_blank(),
        panel.grid.major=element_blank(),
        panel.grid.minor=element_blank(),
        plot.background=element_blank(),
        legend.title=element_blank())
```

<h4 id="RMarkdown"><b>R Markdown</b> (<a href="#Contents">back to contents</a>)</h4>
We now know how to do a range of data analysis, as well as producing a lot of different visualisations. Now we need to know how to compile all of that into a report, and automatically produce that report. The has numerous benefits over the traditional Excel and Word approach to writing out analysis:

* Faster, once the template is written
* More robust - errors are less likely to occur, particuarly when copying from Excel to Word
* Can be updated immediately if/when data changes

There are two elements to R Markdown, the text (which has a number of ways of formatting it) and the code (which can be displayed and included in different ways). We'll look at both of these, but first, we need to open an R Markdown file:

1. Go to File
2. Go to New File
3. Click on R Markdown
4. A new tab will open up in the script pane - have a look at it as it contains an example R Markdown template
5. in the top right hand corner of the script pane click on the arrow next to Knit and click on 'Knit to HTML'
6. Save the R Markdown file in the '2_code' folder
7. The code will run and the output will pop up upon completion
8. Compare this to the input file
9. The output file will have saved in the '2_code' folder - it shouldn't output to here, but we'll sort that later

This is how you generate an R Markdown document. When you make changes to it from now on, you won't have to specify the name and save location every time you knit it.

<div class="tip"><b>Tip:</b> HTML is the preferable output - it is more versatile in designs and can include interactive elements, however if you want to you can also output to Word, and if you have additional software installed (called LaTex and pronounced 'lay-tec') you can output straight to PDF.
</div>

<h5><b>Text</b></h5>
&#35; Heading 1
<br/>

# Heading 1
<br/>
&#35; &#35; Heading 2
<br/>

## Heading 2
<br/>
&#35; &#35; &#35; Heading 3
<br/>

<h3 class="example">Heading3</h3>
<br/>
&#35; &#35; &#35; &#35; Heading 4
<br/>

<h4 class="example">Heading4</h4>
<hr/>

An unordered list:

&#42; Thing 1
<br/>
&#42; Thing 2
<br/>
&#42; Thing 3
<br/>
<br/>
An unordered list:

* Thing 1
* Thing 2
* Thing 3

<hr/>
An ordered list:

&#49;. Thing 1
<br/>
&#50;. Thing 2
<br/>
&#51;. Thing 3
<br/>
<br/>
An ordered list:

1. Thing 1
2. Thing 2
3. Thing 3

<hr/>
A &#91;link&#93;(http://www.yourlinkhere.com)

A [link](http://www.bbc.co.uk/news)
<hr/>
<h5><b>Code</b></h5>

However, the text edits we can make to R Markdown documents are only half of the story - the beauty of it is that you can merge text and the outputs of code. So how do we include code?

Code in R Markdown is written in 'chunks'. Chunks are written in the form below and appear in an R Markdown in a slightly grey section:

<span class="code">&#96;&#96;&#96;&#123;r&#125;
<br/>
print('hello world)
<br/>
&#96;&#96;&#96;</span>

Let's break that down:

1. 3 grave accents signify the start of the code chunk
2. <span class="code">{}</span> signify the metadata that goes with the chunk - more on this in a minute
3. Inside the curly brackets, the <span class="code">r</span> signifies the programming language we're going to be writing in
4. We've then got some code - as many lines as you want with whatever outputs you want
5. 3 grave accents close of the code chunk

Here's what it looks like in an output:

```{r, comment=""}
print('hello world')
```

<div class="activity"><b>Activity:</b> Write this out and run it in your R Markdown documents.
</div>
<br/>
Sometimes we'll want to include this code with outputs, sometimes only outputs, sometimes only code. We can control this using effect messages. Effect messages appear after the <span class="code">r</span> within the curly brackets:

<span class="code">&#96;&#96;&#96;&#123;r, effect_message_here&#125;</span>
<br/>
<br/>

With an effect message you will specify whether that effect is true or false. The list below shows the effect messages that are likely to be useful - the default for all of the message below is true.

* <span class="code">eval = FALSE</span>: Prints the code but not the results
* <span class="code">warning = FALSE</span>: Hides any warnings that come with the code
* <span class="code">echo = FALSE</span>: Hides the code but prints the results
* <span class="code">include = FALSE</span>: Hides code and doesn't print any results (good for setup sections which load in libraries and data)
* <span class="code">message = FALSE</span>: Removes any other messages that come with an output (this is the least common of this set)

<div class="tip"><b>Tip:</b> After <span class="code">r in a code chunk include a new for that chunk - it makes navigating easier, which can be done by clicking in the bottom lefthand corner of the script pane. You can't have multiple sections with the same name though.
</div>

<div class="activity"><b>Activity:</b> Run the code below five times. The first four timed include one of <span class="code">eval/span>, <span class="code">warning/span>, <span class="code">echo/span>, and <span class="code">include/span> in the top of the code chunk, and for the fifth time include whatever combination of effect messages you would need to output this graph for a customer who was only interested in the outputs.
```{r, eval=FALSE}
ggplot(swfc_16,aes(Tot_Workforce_HC,Tot_Teachers_HC)) +
  geom_point()
```
</div>

The final useful code chunk technique is 'inline code'. Often we'll want to calculate values from the data and report them in the text. Traditionally, if we were using Word and Excel, we'd calculate this in Excel, remember the number, and then type it up in Word - think of the things that could go wrong with that! We could get the number wrong when trying to remember it or we could type it wrong. R Markdown allows you to embed values in the text, so that it's directly calculated from the data.

To include an inline piece of code, write this:

&#123;r object_name&#125;

<div class="activity"><b>Activity:</b> In your R Markdown file, write a code chunk that calculates the average total number of FTE Teaching Assistants (<span class="code">Tot_TAs_FTE</span>) and call it <span class="code">ave_tot_tas_fte</span>. Then write a sentence that states what the average total FTE of Teaching Assistants in each school is. Run the code and look at the output.
</div>

<hr/>
<h5><b>Multiple Reports</b></h5>
Remember we wrote an <span class="code">lapply</span> function to produce numerous graph for each different region? We can do the same for R Markdown reports to produce the same report for different entities, and whilst it's got a few more steps than the <span class="code">lapply</span> approach, the premise is the same. We'll nned two file:

* The first is the actual R Markdown file, with a variable in it which will allow us to filter data to produce it for specific entities
* The second is an R script, which will iterate over the categories and produce a Markdown output for each of them.

We'll produce the R Markdown first.

<div class="activity"><b>Activity:</b> Open a new R Markdown and do the following:

1. Remove the template in there currently
2. Create a heading which has an inline code chunk with the variable <span class="code">region_name</span> (this doesn't currently exist - this is the object name that will be the iterand)
3. Write a code chunk which loads in the <span class="code">tidyverse</span> library and the School Workforce Census data - the code and outputs should be hidden
4. Write another code chunk that creates a numeric object (use <span class="code">as.numeric()</span>) which is the number of schools in the region (you might have to trial this with an actual region before replacing it with <span class="code">region_name</span>)
5. Write a sentence which states the number of schools within the region
6. 

ggplot(swfc_16 %>% filter(Government_Office_Region_Name == region_name),
       aes(Tot_Workforce_HC)) +
  geom_histogram() +
    ggtitle(paste0('Distribution of school size in the ',x))
<hr/>
</body>
